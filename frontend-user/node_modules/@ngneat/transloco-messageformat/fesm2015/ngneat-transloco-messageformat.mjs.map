{"version":3,"file":"ngneat-transloco-messageformat.mjs","sources":["../../../../libs/transloco-messageformat/src/lib/messageformat.config.ts","../../../../libs/transloco-messageformat/src/lib/messageformat.factory.ts","../../../../libs/transloco-messageformat/src/lib/messageformat.transpiler.ts","../../../../libs/transloco-messageformat/src/lib/messageformat.module.ts","../../../../libs/transloco-messageformat/src/ngneat-transloco-messageformat.ts"],"sourcesContent":["import { InjectionToken } from '@angular/core';\nimport MessageFormat, { MessageFormatOptions } from '@messageformat/core';\n\nexport const TRANSLOCO_MESSAGE_FORMAT_CONFIG =\n  new InjectionToken<MessageformatConfig>('TRANSLOCO_MESSAGE_FORMAT_CONFIG');\n\nexport type MFLocale = ConstructorParameters<typeof MessageFormat>[0];\n\nexport interface MessageformatConfig extends MessageFormatOptions<'string'> {\n  locales?: MFLocale;\n  enableCache?: boolean;\n}\n","import { MFLocale } from './messageformat.config';\nimport MessageFormat, {\n  MessageFormatOptions,\n  MessageFunction,\n} from '@messageformat/core';\n\nexport type MFFactory = (\n  locales: MFLocale,\n  messageConfig: MessageFormatOptions<'string'>\n) => MessageFormat;\n\nexport function defaultFactory(\n  locales: MFLocale,\n  messageConfig: MessageFormatOptions<'string'>\n): MessageFormat {\n  return new MessageFormat<'string'>(locales, messageConfig);\n}\n\nexport function cachedFactory(\n  locales: MFLocale,\n  messageConfig: MessageFormatOptions<'string'>\n): MessageFormat {\n  const mf = defaultFactory(locales, messageConfig);\n  const original = mf.compile;\n  const cache = new Map<string, MessageFunction<'string'>>();\n  const localeKey = `__${locales?.toString() || MessageFormat.defaultLocale}__`;\n\n  mf.compile = function (messages: string): MessageFunction<'string'> {\n    const cacheKey = `${localeKey}${messages}`;\n    const cachedMsg = cache.get(cacheKey);\n\n    if (cachedMsg) {\n      return cachedMsg;\n    }\n\n    const msg = original.call(this, messages);\n    cache.set(cacheKey, msg);\n\n    return msg;\n  };\n\n  return mf;\n}\n","import { Inject, Injectable, Optional } from '@angular/core';\nimport {\n  DefaultTranspiler,\n  getValue,\n  HashMap,\n  isObject,\n  setValue,\n  Translation,\n  TRANSLOCO_CONFIG,\n  TranslocoConfig,\n} from '@ngneat/transloco';\nimport MessageFormat, { MessageFormatOptions } from '@messageformat/core';\n\nimport {\n  MessageformatConfig,\n  MFLocale,\n  TRANSLOCO_MESSAGE_FORMAT_CONFIG,\n} from './messageformat.config';\nimport {\n  cachedFactory,\n  defaultFactory,\n  MFFactory,\n} from './messageformat.factory';\n\n@Injectable()\nexport class MessageFormatTranspiler extends DefaultTranspiler {\n  private messageFormat: MessageFormat;\n  private readonly messageConfig: MessageFormatOptions<'string'>;\n  private readonly mfFactory: MFFactory;\n\n  constructor(\n    @Optional()\n    @Inject(TRANSLOCO_MESSAGE_FORMAT_CONFIG)\n    config: MessageformatConfig,\n    @Optional() @Inject(TRANSLOCO_CONFIG) userConfig?: TranslocoConfig\n  ) {\n    super(userConfig);\n    const {\n      locales,\n      enableCache = true,\n      ...messageConfig\n    } = { locales: null, ...config };\n    this.messageConfig = messageConfig;\n    this.mfFactory = enableCache ? cachedFactory : defaultFactory;\n    this.messageFormat = this.mfFactory(locales, messageConfig);\n  }\n\n  transpile(value: any, params: HashMap = {}, translation: Translation, key: string): any {\n    if (!value) {\n      return value;\n    }    \n    if (isObject(value) && params) {\n      Object.keys(params).forEach((p) => {\n        const v = getValue(value, p);\n        const getParams = getValue(params, p);\n        const transpiled = super.transpile(v, getParams, translation, key);\n        const message = this.messageFormat.compile(transpiled);\n        value = setValue(value, p, message(params[p]));\n      });\n    } else if (!Array.isArray(value)) {\n      const transpiled = super.transpile(value, params, translation, key);\n\n      const message = this.messageFormat.compile(transpiled);\n      return message(params);\n    }\n\n    return value;\n  }\n\n  onLangChanged(lang: string) {\n    this.setLocale(lang);\n  }\n\n  setLocale(locale: MFLocale) {\n    this.messageFormat = this.mfFactory(locale, this.messageConfig);\n  }\n}\n","import { NgModule, ModuleWithProviders } from '@angular/core';\nimport { TRANSLOCO_TRANSPILER } from '@ngneat/transloco';\nimport { MessageFormatTranspiler } from './messageformat.transpiler';\nimport {\n  TRANSLOCO_MESSAGE_FORMAT_CONFIG,\n  MessageformatConfig,\n} from './messageformat.config';\n\n@NgModule()\nexport class TranslocoMessageFormatModule {\n  static forRoot(\n    config?: MessageformatConfig\n  ): ModuleWithProviders<TranslocoMessageFormatModule> {\n    return {\n      ngModule: TranslocoMessageFormatModule,\n      providers: [\n        { provide: TRANSLOCO_MESSAGE_FORMAT_CONFIG, useValue: config },\n        {\n          provide: TRANSLOCO_TRANSPILER,\n          useClass: MessageFormatTranspiler,\n        },\n      ],\n    };\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}