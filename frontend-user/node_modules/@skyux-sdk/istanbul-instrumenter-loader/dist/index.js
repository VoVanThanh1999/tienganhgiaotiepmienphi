"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const convert_source_map_1 = __importDefault(require("convert-source-map"));
const istanbul_lib_instrument_1 = require("istanbul-lib-instrument");
const loader_utils_1 = require("loader-utils");
const schema_utils_1 = __importDefault(require("schema-utils"));
/* tslint:disable-next-line:no-var-requires */
const schema = require('./schema.json');
/**
 * Source code inspired by `istanbul-instrumenter-loader`.
 * @see https://github.com/webpack-contrib/istanbul-instrumenter-loader
 */
function default_1(source, sourceMap) {
    const defaults = {
        produceSourceMap: true
    };
    const options = Object.assign(defaults, loader_utils_1.getOptions(this));
    schema_utils_1.default(schema, options, {
        name: 'Istanbul Instrumenter Loader'
    });
    let srcMap = sourceMap;
    // Use inline source map, if none provided.
    if (!srcMap) {
        const inlineSourceMap = convert_source_map_1.default.fromSource(source);
        /* istanbul ignore else */
        if (inlineSourceMap) {
            srcMap = inlineSourceMap.sourcemap;
        }
    }
    const instrumenter = istanbul_lib_instrument_1.createInstrumenter(options);
    instrumenter.instrument(source, this.resourcePath, (error, instrumentedSource) => {
        this.callback(error, instrumentedSource, instrumenter.lastSourceMap());
    }, srcMap);
}
exports.default = default_1;
