import * as fs from 'fs';
import { join } from 'path';
import { getISROptions } from '../utils/get-isr-options';
export class FileSystemCacheHandler {
    constructor(options) {
        this.options = options;
        this.cache = new Map();
        if (!options.cacheFolderPath) {
            throw new Error('Cache folder path is required!');
        }
        if (options.addPrerenderedPagesToCache && !options.prerenderedPagesPath) {
            throw new Error('Prerendered pages path is required when `addPrerenderedPagesToCache` is enabled!');
        }
        this.options = options;
        this.populateCacheFromFilesystem();
    }
    get cacheFolderPath() {
        return this.options.cacheFolderPath;
    }
    async add(route, html, options) {
        return new Promise((resolve, reject) => {
            route = route.charAt(0) === '/' ? route.slice(1) : route;
            const fileName = convertRouteToFileName(route);
            const filePath = `${this.getFileFullPath(fileName)}.html`;
            fs.writeFile(filePath, html, 'utf-8', (err) => {
                if (err) {
                    reject('Error: ðŸ’¥ The request was not cached!');
                }
                this.cache.set(route, {
                    html: filePath,
                    options: options || { revalidate: null },
                    createdAt: Date.now(),
                });
                console.log('The request was cached!', route);
                resolve();
            });
        });
    }
    get(route) {
        return new Promise(async (resolve, reject) => {
            const cachedUrl = this.cache.get(route);
            if (cachedUrl) {
                // on html field we have saved path to file
                const html = await this.readFromFile(cachedUrl.html);
                const cacheData = {
                    ...cachedUrl,
                    html,
                };
                resolve(cacheData);
            }
            else {
                reject('Error: ðŸ’¥ Url is not cached.');
            }
        });
    }
    has(url) {
        return Promise.resolve(this.cache.has(url));
    }
    delete(url) {
        return new Promise((resolve, reject) => {
            const cachedUrl = this.cache.get(url);
            if (cachedUrl) {
                const filePath = this.getFileFullPath(url);
                fs.unlink(cachedUrl.html, (err) => {
                    if (err) {
                        reject('Error: ðŸ’¥ Cannot delete file' + filePath);
                    }
                    else {
                        this.cache.delete(url);
                        resolve(true);
                    }
                });
            }
            else {
                reject('Error: ðŸ’¥ Url is not cached.');
            }
        });
    }
    getAll() {
        const data = Array.from(this.cache.keys());
        return Promise.resolve(data);
    }
    populateCacheFromFilesystem() {
        if (!fs.existsSync(this.cacheFolderPath)) {
            console.log('Cache folder does not exist. Creating...');
            fs.mkdir(this.cacheFolderPath, (err) => {
                if (!err) {
                    console.log('Cache folder was created.');
                }
            });
        }
        if (this.options.addPrerenderedPagesToCache) {
            console.log('Adding prerendered pages to cache...');
            this.addPrerenderedPagesToCache();
        }
    }
    addPrerenderedPagesToCache() {
        // read all folders in browser folder and check if they have index.html inside
        // if yes add the folder name to cache as url and index.html as html
        // then remove the found files because they will be handled by ISR
        const folderPath = this.options.prerenderedPagesPath;
        const pathsToCache = [];
        try {
            const files = fs.readdirSync(folderPath);
            for (const file of files) {
                const filePath = join(folderPath, file);
                const isDirectory = fs.statSync(filePath).isDirectory();
                if (isDirectory) {
                    const indexHtmlFiles = findIndexHtmlFilesRecursively(filePath);
                    pathsToCache.push(...indexHtmlFiles.map(({ path, html }) => ({
                        path: path.replace(folderPath, ''),
                        html,
                    })));
                }
            }
        }
        catch (err) {
            console.error('ERROR! ðŸ’¥ ! Cannot read folder: ' + folderPath);
        }
        for (const { path, html } of pathsToCache) {
            const routePath = path.substring(0).replace('/index.html', '');
            const { revalidate, errors } = getISROptions(html);
            this.add(routePath, html, { revalidate, errors });
        }
        for (const { path } of pathsToCache) {
            const file = join(this.options.prerenderedPagesPath, path);
            fs.rmSync(file, { recursive: true, force: true });
        }
    }
    async readFromFile(filePath) {
        return new Promise((resolve, reject) => {
            fs.readFile(filePath, 'utf-8', (err, data) => {
                if (err) {
                    console.error('ERROR! ðŸ’¥ ! Cannot read file: ' + filePath);
                    reject(err);
                }
                resolve(data);
            });
        });
    }
    getFileFullPath(fileName) {
        // fileName may have a / in the beginning, so we want to remove it first
        if (fileName.charAt(0) === '/') {
            fileName = fileName.slice(1);
        }
        return join(this.cacheFolderPath, '/', fileName);
    }
}
function findIndexHtmlFilesRecursively(path) {
    const data = [];
    try {
        const files = fs.readdirSync(path);
        files.forEach((file) => {
            const filePath = join(path, file);
            if (fs.statSync(filePath).isDirectory()) {
                data.push(...findIndexHtmlFilesRecursively(filePath));
            }
            else if (file.includes('index.html')) {
                const html = fs.readFileSync(filePath, 'utf8');
                data.push({ path: filePath, html });
            }
        });
    }
    catch (err) {
        console.error('ERROR! ðŸ’¥ ! Cannot read folder: ' + path);
        return [];
    }
    return data;
}
function convertRouteToFileName(route) {
    return route.replace(new RegExp('/', 'g'), '__');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZXN5c3RlbS1jYWNoZS1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWlzci9zcmMvbGliL2NhY2hlLWhhbmRsZXJzL2ZpbGVzeXN0ZW0tY2FjaGUtaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQVF6RCxNQUFNLE9BQU8sc0JBQXNCO0lBT2pDLFlBQW1CLE9BQStCO1FBQS9CLFlBQU8sR0FBUCxPQUFPLENBQXdCO1FBTnhDLFVBQUssR0FBRyxJQUFJLEdBQUcsRUFBcUIsQ0FBQztRQU83QyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRTtZQUM1QixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7U0FDbkQ7UUFFRCxJQUFJLE9BQU8sQ0FBQywwQkFBMEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRTtZQUN2RSxNQUFNLElBQUksS0FBSyxDQUNiLGtGQUFrRixDQUNuRixDQUFDO1NBQ0g7UUFFRCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0lBakJELElBQVksZUFBZTtRQUN6QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDO0lBQ3RDLENBQUM7SUFpQkQsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFhLEVBQUUsSUFBWSxFQUFFLE9BQW9CO1FBQ3pELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxD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LElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0JBQ3RDLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2FBQ3JDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7S0FDSjtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1osT0FBTyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUN6RCxPQUFPLEVBQUUsQ0FBQztLQUNYO0lBRUQsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQsU0FBUyxzQkFBc0IsQ0FBQyxLQUFhO0lBQzNDLE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDbkQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhY2hlRGF0YSwgQ2FjaGVIYW5kbGVyLCBJU1JPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWxzJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IGdldElTUk9wdGlvbnMgfSBmcm9tICcuLi91dGlscy9nZXQtaXNyLW9wdGlvbnMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEZpbGVTeXN0ZW1DYWNoZU9wdGlvbnMge1xuICBjYWNoZUZvbGRlclBhdGg6IHN0cmluZztcbiAgcHJlcmVuZGVyZWRQYWdlc1BhdGg/OiBzdHJpbmc7XG4gIGFkZFByZXJlbmRlcmVkUGFnZXNUb0NhY2hlPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIEZpbGVTeXN0ZW1DYWNoZUhhbmRsZXIgaW1wbGVtZW50cyBDYWNoZUhhbmRsZXIge1xuICBwcm90ZWN0ZWQgY2FjaGUgPSBuZXcgTWFwPHN0cmluZywgQ2FjaGVEYXRhPigpO1xuXG4gIHByaXZhdGUgZ2V0IGNhY2hlRm9sZGVyUGF0aCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMuY2FjaGVGb2xkZXJQYXRoO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHVibGljIG9wdGlvbnM6IEZpbGVTeXN0ZW1DYWNoZU9wdGlvbnMpIHtcbiAgICBpZiAoIW9wdGlvbnMuY2FjaGVGb2xkZXJQYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhY2hlIGZvbGRlciBwYXRoIGlzIHJlcXVpcmVkIScpO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmFkZFByZXJlbmRlcmVkUGFnZXNUb0NhY2hlICYmICFvcHRpb25zLnByZXJlbmRlcmVkUGFnZXNQYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdQcmVyZW5kZXJlZCBwYWdlcyBwYXRoIGlzIHJlcXVpcmVkIHdoZW4gYGFkZFByZXJlbmRlcmVkUGFnZXNUb0NhY2hlYCBpcyBlbmFibGVkISdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICB0aGlzLnBvcHVsYXRlQ2FjaGVGcm9tRmlsZXN5c3RlbSgpO1xuICB9XG5cbiAgYXN5bmMgYWRkKHJvdXRlOiBzdHJpbmcsIGh0bWw6IHN0cmluZywgb3B0aW9ucz86IElTUk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgcm91dGUgPSByb3V0ZS5jaGFyQXQoMCkgPT09ICcvJyA/IHJvdXRlLnNsaWNlKDEpIDogcm91dGU7XG4gICAgICBjb25zdCBmaWxlTmFtZSA9IGNvbnZlcnRSb3V0ZVRvRmlsZU5hbWUocm91dGUpO1xuICAgICAgY29uc3QgZmlsZVBhdGggPSBgJHt0aGlzLmdldEZpbGVGdWxsUGF0aChmaWxlTmFtZSl9Lmh0bWxgO1xuXG4gICAgICBmcy53cml0ZUZpbGUoZmlsZVBhdGgsIGh0bWwsICd1dGYtOCcsIChlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdCgnRXJyb3I6IPCfkqUgVGhlIHJlcXVlc3Qgd2FzIG5vdCBjYWNoZWQhJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNhY2hlLnNldChyb3V0ZSwge1xuICAgICAgICAgIGh0bWw6IGZpbGVQYXRoLFxuICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMgfHwgeyByZXZhbGlkYXRlOiBudWxsIH0sXG4gICAgICAgICAgY3JlYXRlZEF0OiBEYXRlLm5vdygpLFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zb2xlLmxvZygnVGhlIHJlcXVlc3Qgd2FzIGNhY2hlZCEnLCByb3V0ZSk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0KHJvdXRlOiBzdHJpbmcpOiBQcm9taXNlPENhY2hlRGF0YT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBjYWNoZWRVcmwgPSB0aGlzLmNhY2hlLmdldChyb3V0ZSk7XG4gICAgICBpZiAoY2FjaGVkVXJsKSB7XG4gICAgICAgIC8vIG9uIGh0bWwgZmllbGQgd2UgaGF2ZSBzYXZlZCBwYXRoIHRvIGZpbGVcbiAgICAgICAgY29uc3QgaHRtbCA9IGF3YWl0IHRoaXMucmVhZEZyb21GaWxlKGNhY2hlZFVybC5odG1sKTtcbiAgICAgICAgY29uc3QgY2FjaGVEYXRhOiBDYWNoZURhdGEgPSB7XG4gICAgICAgICAgLi4uY2FjaGVkVXJsLFxuICAgICAgICAgIGh0bWwsXG4gICAgICAgIH07XG4gICAgICAgIHJlc29sdmUoY2FjaGVEYXRhKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlamVjdCgnRXJyb3I6IPCfkqUgVXJsIGlzIG5vdCBjYWNoZWQuJyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBoYXModXJsOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuY2FjaGUuaGFzKHVybCkpO1xuICB9XG5cbiAgZGVsZXRlKHVybDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGNhY2hlZFVybCA9IHRoaXMuY2FjaGUuZ2V0KHVybCk7XG5cbiAgICAgIGlmIChjYWNoZWRVcmwpIHtcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSB0aGlzLmdldEZpbGVGdWxsUGF0aCh1cmwpO1xuICAgICAgICBmcy51bmxpbmsoY2FjaGVkVXJsLmh0bWwsIChlcnIpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICByZWplY3QoJ0Vycm9yOiDwn5KlIENhbm5vdCBkZWxldGUgZmlsZScgKyBmaWxlUGF0aCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKHVybCk7XG4gICAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZWplY3QoJ0Vycm9yOiDwn5KlIFVybCBpcyBub3QgY2FjaGVkLicpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0QWxsKCk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCBkYXRhID0gQXJyYXkuZnJvbSh0aGlzLmNhY2hlLmtleXMoKSk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgcG9wdWxhdGVDYWNoZUZyb21GaWxlc3lzdGVtKCk6IHZvaWQge1xuICAgIGlmICghZnMuZXhpc3RzU3luYyh0aGlzLmNhY2hlRm9sZGVyUGF0aCkpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdDYWNoZSBmb2xkZXIgZG9lcyBub3QgZXhpc3QuIENyZWF0aW5nLi4uJyk7XG5cbiAgICAgIGZzLm1rZGlyKHRoaXMuY2FjaGVGb2xkZXJQYXRoLCAoZXJyKSA9PiB7XG4gICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ0NhY2hlIGZvbGRlciB3YXMgY3JlYXRlZC4nKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub3B0aW9ucy5hZGRQcmVyZW5kZXJlZFBhZ2VzVG9DYWNoZSkge1xuICAgICAgY29uc29sZS5sb2coJ0FkZGluZyBwcmVyZW5kZXJlZCBwYWdlcyB0byBjYWNoZS4uLicpO1xuICAgICAgdGhpcy5hZGRQcmVyZW5kZXJlZFBhZ2VzVG9DYWNoZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUHJlcmVuZGVyZWRQYWdlc1RvQ2FjaGUoKSB7XG4gICAgLy8gcmVhZCBhbGwgZm9sZGVycyBpbiBicm93c2VyIGZvbGRlciBhbmQgY2hlY2sgaWYgdGhleSBoYXZlIGluZGV4Lmh0bWwgaW5zaWRlXG4gICAgLy8gaWYgeWVzIGFkZCB0aGUgZm9sZGVyIG5hbWUgdG8gY2FjaGUgYXMgdXJsIGFuZCBpbmRleC5odG1sIGFzIGh0bWxcbiAgICAvLyB0aGVuIHJlbW92ZSB0aGUgZm91bmQgZmlsZXMgYmVjYXVzZSB0aGV5IHdpbGwgYmUgaGFuZGxlZCBieSBJU1JcblxuICAgIGNvbnN0IGZvbGRlclBhdGggPSB0aGlzLm9wdGlvbnMucHJlcmVuZGVyZWRQYWdlc1BhdGghO1xuXG4gICAgY29uc3QgcGF0aHNUb0NhY2hlOiBBcnJheTx7IHBhdGg6IHN0cmluZzsgaHRtbDogc3RyaW5nIH0+ID0gW107XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgZmlsZXM6IHN0cmluZ1tdID0gZnMucmVhZGRpclN5bmMoZm9sZGVyUGF0aCk7XG5cbiAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICBjb25zdCBmaWxlUGF0aCA9IGpvaW4oZm9sZGVyUGF0aCwgZmlsZSk7XG4gICAgICAgIGNvbnN0IGlzRGlyZWN0b3J5ID0gZnMuc3RhdFN5bmMoZmlsZVBhdGgpLmlzRGlyZWN0b3J5KCk7XG5cbiAgICAgICAgaWYgKGlzRGlyZWN0b3J5KSB7XG4gICAgICAgICAgY29uc3QgaW5kZXhIdG1sRmlsZXMgPSBmaW5kSW5kZXhIdG1sRmlsZXNSZWN1cnNpdmVseShmaWxlUGF0aCk7XG5cbiAgICAgICAgICBwYXRoc1RvQ2FjaGUucHVzaChcbiAgICAgICAgICAgIC4uLmluZGV4SHRtbEZpbGVzLm1hcCgoeyBwYXRoLCBodG1sIH0pID0+ICh7XG4gICAgICAgICAgICAgIHBhdGg6IHBhdGgucmVwbGFjZShmb2xkZXJQYXRoLCAnJyksXG4gICAgICAgICAgICAgIGh0bWwsXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFUlJPUiEg8J+SpSAhIENhbm5vdCByZWFkIGZvbGRlcjogJyArIGZvbGRlclBhdGgpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgeyBwYXRoLCBodG1sIH0gb2YgcGF0aHNUb0NhY2hlKSB7XG4gICAgICBjb25zdCByb3V0ZVBhdGggPSBwYXRoLnN1YnN0cmluZygwKS5yZXBsYWNlKCcvaW5kZXguaHRtbCcsICcnKTtcbiAgICAgIGNvbnN0IHsgcmV2YWxpZGF0ZSwgZXJyb3JzIH0gPSBnZXRJU1JPcHRpb25zKGh0bWwpO1xuICAgICAgdGhpcy5hZGQocm91dGVQYXRoLCBodG1sLCB7IHJldmFsaWRhdGUsIGVycm9ycyB9KTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHsgcGF0aCB9IG9mIHBhdGhzVG9DYWNoZSkge1xuICAgICAgY29uc3QgZmlsZSA9IGpvaW4odGhpcy5vcHRpb25zLnByZXJlbmRlcmVkUGFnZXNQYXRoISwgcGF0aCk7XG4gICAgICBmcy5ybVN5bmMoZmlsZSwgeyByZWN1cnNpdmU6IHRydWUsIGZvcmNlOiB0cnVlIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVhZEZyb21GaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBmcy5yZWFkRmlsZShmaWxlUGF0aCwgJ3V0Zi04JywgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRVJST1IhIPCfkqUgISBDYW5ub3QgcmVhZCBmaWxlOiAnICsgZmlsZVBhdGgpO1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoZGF0YSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RmlsZUZ1bGxQYXRoKGZpbGVOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIGZpbGVOYW1lIG1heSBoYXZlIGEgLyBpbiB0aGUgYmVnaW5uaW5nLCBzbyB3ZSB3YW50IHRvIHJlbW92ZSBpdCBmaXJzdFxuICAgIGlmIChmaWxlTmFtZS5jaGFyQXQoMCkgPT09ICcvJykge1xuICAgICAgZmlsZU5hbWUgPSBmaWxlTmFtZS5zbGljZSgxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gam9pbih0aGlzLmNhY2hlRm9sZGVyUGF0aCwgJy8nLCBmaWxlTmFtZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZmluZEluZGV4SHRtbEZpbGVzUmVjdXJzaXZlbHkoXG4gIHBhdGg6IHN0cmluZ1xuKTogQXJyYXk8eyBwYXRoOiBzdHJpbmc7IGh0bWw6IHN0cmluZyB9PiB7XG4gIGNvbnN0IGRhdGE6IEFycmF5PHsgcGF0aDogc3RyaW5nOyBodG1sOiBzdHJpbmcgfT4gPSBbXTtcblxuICB0cnkge1xuICAgIGNvbnN0IGZpbGVzID0gZnMucmVhZGRpclN5bmMocGF0aCk7XG4gICAgZmlsZXMuZm9yRWFjaCgoZmlsZTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBmaWxlUGF0aCA9IGpvaW4ocGF0aCwgZmlsZSk7XG4gICAgICBpZiAoZnMuc3RhdFN5bmMoZmlsZVBhdGgpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgZGF0YS5wdXNoKC4uLmZpbmRJbmRleEh0bWxGaWxlc1JlY3Vyc2l2ZWx5KGZpbGVQYXRoKSk7XG4gICAgICB9IGVsc2UgaWYgKGZpbGUuaW5jbHVkZXMoJ2luZGV4Lmh0bWwnKSkge1xuICAgICAgICBjb25zdCBodG1sID0gZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCAndXRmOCcpO1xuICAgICAgICBkYXRhLnB1c2goeyBwYXRoOiBmaWxlUGF0aCwgaHRtbCB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignRVJST1IhIPCfkqUgISBDYW5ub3QgcmVhZCBmb2xkZXI6ICcgKyBwYXRoKTtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gY29udmVydFJvdXRlVG9GaWxlTmFtZShyb3V0ZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHJvdXRlLnJlcGxhY2UobmV3IFJlZ0V4cCgnLycsICdnJyksICdfXycpO1xufVxuIl19