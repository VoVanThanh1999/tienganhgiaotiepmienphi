import { renderUrl } from './utils/render-url';
import { getISROptions } from './utils/get-isr-options';
export class CacheRegeneration {
    constructor(cache, indexHtml) {
        this.cache = cache;
        this.indexHtml = indexHtml;
        // TODO: make this pluggable because on serverless environments we can't share memory between functions
        // so we need to use a database or redis cache to store the urls that are on hold if we want to use this feature
        this.urlsOnHold = []; // urls that have regeneration loading
    }
    async regenerate(req, res, cacheData, logger, providers) {
        const { url } = req;
        if (this.urlsOnHold.includes(url)) {
            logger.log('Another regeneration is on-going...');
            return;
        }
        const { options } = cacheData;
        const { revalidate } = options;
        logger.log(`The url: ${url} is being regenerated.`);
        this.urlsOnHold.push(url);
        renderUrl({ req, res, url, indexHtml: this.indexHtml, providers }).then((html) => {
            const { errors } = getISROptions(html);
            if (errors?.length) {
                logger.log('ðŸ’¥ ERROR: Url: ' + url + ' was not regenerated!', errors);
                return;
            }
            // add the regenerated page to cache
            this.cache.add(req.url, html, { revalidate }).then(() => {
                // remove url from urlsOnHold
                this.urlsOnHold = this.urlsOnHold.filter((x) => x !== url);
                logger.log('Url: ' + url + ' was regenerated!');
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtcmVnZW5lcmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWlzci9zcmMvbGliL2NhY2hlLXJlZ2VuZXJhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBSXhELE1BQU0sT0FBTyxpQkFBaUI7SUFLNUIsWUFBbUIsS0FBbUIsRUFBUyxTQUFpQjtRQUE3QyxVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQVMsY0FBUyxHQUFULFNBQVMsQ0FBUTtRQUpoRSx1R0FBdUc7UUFDdkcsZ0hBQWdIO1FBQ3hHLGVBQVUsR0FBYSxFQUFFLENBQUMsQ0FBQyxzQ0FBc0M7SUFFTixDQUFDO0lBRXBFLEtBQUssQ0FBQyxVQUFVLENBQ2QsR0FBWSxFQUNaLEdBQWEsRUFDYixTQUFvQixFQUNwQixNQUFpQixFQUNqQixTQUFzQjtRQUV0QixNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsR0FBRyxDQUFDO1FBRXBCLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDakMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1lBQ2xELE9BQU87U0FDUjtRQUVELE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxTQUFTLENBQUM7UUFDOUIsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLE9BQU8sQ0FBQztRQUUvQixNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyx3QkFBd0IsQ0FBQyxDQUFDO1FBRXBELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTFCLFNBQVMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUNyRSxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ1AsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUV2QyxJQUFJLE1BQU0sRUFBRSxNQUFNLEVBQUU7Z0JBQ2xCLE1BQU0sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEdBQUcsR0FBRyxHQUFHLHVCQUF1QixFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUN0RSxPQUFPO2FBQ1I7WUFFRCxvQ0FBb0M7WUFDcEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ3RELDZCQUE2QjtnQkFDN0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO2dCQUMzRCxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxHQUFHLEdBQUcsbUJBQW1CLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJvdmlkZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENhY2hlRGF0YSwgQ2FjaGVIYW5kbGVyIH0gZnJvbSAnLi9tb2RlbHMnO1xuaW1wb3J0IHsgcmVuZGVyVXJsIH0gZnJvbSAnLi91dGlscy9yZW5kZXItdXJsJztcbmltcG9ydCB7IGdldElTUk9wdGlvbnMgfSBmcm9tICcuL3V0aWxzL2dldC1pc3Itb3B0aW9ucyc7XG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgSVNSTG9nZ2VyIH0gZnJvbSAnLi9pc3ItbG9nZ2VyJztcblxuZXhwb3J0IGNsYXNzIENhY2hlUmVnZW5lcmF0aW9uIHtcbiAgLy8gVE9ETzogbWFrZSB0aGlzIHBsdWdnYWJsZSBiZWNhdXNlIG9uIHNlcnZlcmxlc3MgZW52aXJvbm1lbnRzIHdlIGNhbid0IHNoYXJlIG1lbW9yeSBiZXR3ZWVuIGZ1bmN0aW9uc1xuICAvLyBzbyB3ZSBuZWVkIHRvIHVzZSBhIGRhdGFiYXNlIG9yIHJlZGlzIGNhY2hlIHRvIHN0b3JlIHRoZSB1cmxzIHRoYXQgYXJlIG9uIGhvbGQgaWYgd2Ugd2FudCB0byB1c2UgdGhpcyBmZWF0dXJlXG4gIHByaXZhdGUgdXJsc09uSG9sZDogc3RyaW5nW10gPSBbXTsgLy8gdXJscyB0aGF0IGhhdmUgcmVnZW5lcmF0aW9uIGxvYWRpbmdcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgY2FjaGU6IENhY2hlSGFuZGxlciwgcHVibGljIGluZGV4SHRtbDogc3RyaW5nKSB7fVxuXG4gIGFzeW5jIHJlZ2VuZXJhdGUoXG4gICAgcmVxOiBSZXF1ZXN0LFxuICAgIHJlczogUmVzcG9uc2UsXG4gICAgY2FjaGVEYXRhOiBDYWNoZURhdGEsXG4gICAgbG9nZ2VyOiBJU1JMb2dnZXIsXG4gICAgcHJvdmlkZXJzPzogUHJvdmlkZXJbXVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB7IHVybCB9ID0gcmVxO1xuXG4gICAgaWYgKHRoaXMudXJsc09uSG9sZC5pbmNsdWRlcyh1cmwpKSB7XG4gICAgICBsb2dnZXIubG9nKCdBbm90aGVyIHJlZ2VuZXJhdGlvbiBpcyBvbi1nb2luZy4uLicpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgb3B0aW9ucyB9ID0gY2FjaGVEYXRhO1xuICAgIGNvbnN0IHsgcmV2YWxpZGF0ZSB9ID0gb3B0aW9ucztcblxuICAgIGxvZ2dlci5sb2coYFRoZSB1cmw6ICR7dXJsfSBpcyBiZWluZyByZWdlbmVyYXRlZC5gKTtcblxuICAgIHRoaXMudXJsc09uSG9sZC5wdXNoKHVybCk7XG5cbiAgICByZW5kZXJVcmwoeyByZXEsIHJlcywgdXJsLCBpbmRleEh0bWw6IHRoaXMuaW5kZXhIdG1sLCBwcm92aWRlcnMgfSkudGhlbihcbiAgICAgIChodG1sKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgZXJyb3JzIH0gPSBnZXRJU1JPcHRpb25zKGh0bWwpO1xuXG4gICAgICAgIGlmIChlcnJvcnM/Lmxlbmd0aCkge1xuICAgICAgICAgIGxvZ2dlci5sb2coJ/CfkqUgRVJST1I6IFVybDogJyArIHVybCArICcgd2FzIG5vdCByZWdlbmVyYXRlZCEnLCBlcnJvcnMpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGFkZCB0aGUgcmVnZW5lcmF0ZWQgcGFnZSB0byBjYWNoZVxuICAgICAgICB0aGlzLmNhY2hlLmFkZChyZXEudXJsLCBodG1sLCB7IHJldmFsaWRhdGUgfSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgLy8gcmVtb3ZlIHVybCBmcm9tIHVybHNPbkhvbGRcbiAgICAgICAgICB0aGlzLnVybHNPbkhvbGQgPSB0aGlzLnVybHNPbkhvbGQuZmlsdGVyKCh4KSA9PiB4ICE9PSB1cmwpO1xuICAgICAgICAgIGxvZ2dlci5sb2coJ1VybDogJyArIHVybCArICcgd2FzIHJlZ2VuZXJhdGVkIScpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICApO1xuICB9XG59XG4iXX0=