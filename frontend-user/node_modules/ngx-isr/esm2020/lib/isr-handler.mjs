import { CacheHandler, } from './models';
import { InMemoryCacheHandler } from './cache-handlers';
import { renderUrl } from './utils/render-url';
import { getISROptions } from './utils/get-isr-options';
import { CacheRegeneration } from './cache-regeneration';
import { ISRLogger } from './isr-logger';
export class ISRHandler {
    constructor(config) {
        if (!config) {
            throw new Error('Provide ISRHandlerConfig!');
        }
        this.isrConfig = config;
        this.logger = new ISRLogger(config?.enableLogging ?? false);
        // if skipCachingOnHttpError is not provided it will default to true
        this.isrConfig.skipCachingOnHttpError =
            config?.skipCachingOnHttpError !== false;
        if (config.cache && config.cache instanceof CacheHandler) {
            this.logger.log('Using custom cache handler!');
            this.cache = config.cache;
        }
        else {
            this.logger.log('Using in memory cache handler!');
            this.cache = new InMemoryCacheHandler();
        }
        this.cacheRegeneration = new CacheRegeneration(this.cache, config.indexHtml);
    }
    async invalidate(req, res, config) {
        const { token, urlsToInvalidate } = extractDataFromBody(req);
        const { indexHtml } = this.isrConfig;
        if (token !== this.isrConfig.invalidateSecretToken) {
            return res.json({ status: 'error', message: 'Your secret token is wrong!!!' });
        }
        if (!urlsToInvalidate || !urlsToInvalidate.length) {
            return res.json({ status: 'error', message: 'Please add `urlsToInvalidate` in the payload!' });
        }
        const notInCache = [];
        const urlWithErrors = {};
        for (const url of urlsToInvalidate) {
            const urlExists = await this.cache.has(url);
            if (!urlExists) {
                notInCache.push(url);
                continue;
            }
            try {
                // re-render the page again
                const html = await renderUrl({ req, res, url, indexHtml, providers: config?.providers });
                // get revalidate data in order to set it to cache data
                const { revalidate, errors } = getISROptions(html);
                // if there are errors when rendering the site we throw an error
                if (errors?.length && this.isrConfig.skipCachingOnHttpError) {
                    urlWithErrors[url] = errors;
                }
                // add the regenerated page to cache
                await this.cache.add(req.url, html, { revalidate });
            }
            catch (err) {
                urlWithErrors[url] = err;
            }
        }
        const invalidatedUrls = urlsToInvalidate.filter(url => !notInCache.includes(url) && !urlWithErrors[url]);
        if (notInCache.length) {
            this.logger.log(`Urls: ${notInCache.join(', ')} does not exist in cache.`);
        }
        if (Object.keys(urlWithErrors).length) {
            this.logger.log(`Urls: ${Object.keys(urlWithErrors).join(', ')} had errors while regenerating!`);
        }
        if (invalidatedUrls.length) {
            this.logger.log(`Urls: ${invalidatedUrls.join(', ')} were regenerated!`);
        }
        const response = { status: 'success', notInCache, urlWithErrors, invalidatedUrls };
        return res.json(response);
    }
    async serveFromCache(req, res, next, config) {
        try {
            const cacheData = await this.cache.get(req.url);
            const { html, options, createdAt } = cacheData;
            // if the cache is expired, we will regenerate it
            if (options.revalidate && options.revalidate > 0) {
                const lastCacheDateDiff = (Date.now() - createdAt) / 1000; // in seconds
                if (lastCacheDateDiff > options.revalidate) {
                    await this.cacheRegeneration.regenerate(req, res, cacheData, this.logger, config?.providers);
                }
            }
            // Apply the callback if given
            let finalHtml = html;
            if (config?.modifyCachedHtml) {
                const timeStart = performance.now();
                finalHtml = config.modifyCachedHtml(req, html);
                const totalTime = performance.now() - timeStart;
                finalHtml += `<!--\nℹ️ NgxISR: This cachedHtml has been modified with modifyCachedHtml()\n❗️ This resulted into more ${totalTime.toFixed(2)}ms of processing time.\n-->`;
            }
            // Cache exists. Send it.
            this.logger.log(`Page was retrieved from cache: `, req.url);
            return res.send(finalHtml);
        }
        catch (error) {
            // Cache does not exist. Serve user using SSR
            next();
        }
    }
    async render(req, res, next, config) {
        const renderUrlConfig = {
            req,
            res,
            url: req.url,
            indexHtml: this.isrConfig.indexHtml,
            providers: config?.providers,
        };
        renderUrl(renderUrlConfig).then(async (html) => {
            const { revalidate, errors } = getISROptions(html);
            // Apply the callback if given
            const finalHtml = config?.modifyGeneratedHtml ? config.modifyGeneratedHtml(req, html) : html;
            // if we have any http errors when rendering the site, and we have skipCachingOnHttpError enabled
            // we don't want to cache it, and, we will fall back to client side rendering
            if (errors?.length && this.isrConfig.skipCachingOnHttpError) {
                this.logger.log('Http errors: \n', errors);
                return res.send(finalHtml);
            }
            // if revalidate is null we won't cache it
            // if revalidate is 0, we will never clear the cache automatically
            // if revalidate is x, we will clear cache every x seconds (after the last request) for that url
            if (revalidate === null || revalidate === undefined) {
                // don't do !revalidate because it will also catch "0"
                return res.send(finalHtml);
            }
            // Cache the rendered `html` for this request url to use for subsequent requests
            await this.cache.add(req.url, finalHtml, { revalidate });
            return res.send(finalHtml);
        });
    }
}
const extractDataFromBody = (req) => {
    const { urlsToInvalidate, token } = req.body;
    return { urlsToInvalidate, token };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXNyLWhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaXNyL3NyYy9saWIvaXNyLWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFlBQVksR0FLYixNQUFNLFVBQVUsQ0FBQztBQUNsQixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFtQixNQUFNLG9CQUFvQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUV6RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRXpDLE1BQU0sT0FBTyxVQUFVO0lBUXJCLFlBQVksTUFBeUI7UUFDbkMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUM5QztRQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDO1FBRXhCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxTQUFTLENBQUMsTUFBTSxFQUFFLGFBQWEsSUFBSSxLQUFLLENBQUMsQ0FBQztRQUU1RCxvRUFBb0U7UUFDcEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxzQkFBc0I7WUFDbkMsTUFBTSxFQUFFLHNCQUFzQixLQUFLLEtBQUssQ0FBQztRQUUzQyxJQUFJLE1BQU0sQ0FBQyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssWUFBWSxZQUFZLEVBQUU7WUFDeEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FBQztZQUMvQyxJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7U0FDM0I7YUFBTTtZQUNMLElBQUksQ0FBQyxNQUFNLENB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QUFHLE1BQU0sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBRTdGLGlHQUFpRztZQUNqRyw2RUFBNkU7WUFDN0UsSUFBSSxNQUFNLEVBQUUsTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsc0JBQXNCLEVBQUU7Z0JBQzNELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUMzQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDNUI7WUFFRCwwQ0FBMEM7WUFDMUMsa0VBQWtFO1lBQ2xFLGdHQUFnRztZQUVoRyxJQUFJLFVBQVUsS0FBSyxJQUFJLElBQUksVUFBVSxLQUFLLFNBQVMsRUFBRTtnQkFDbkQsc0RBQXNEO2dCQUN0RCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDNUI7WUFFRCxnRkFBZ0Y7WUFDaEYsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDekQsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBRUQsTUFBTSxtQkFBbUIsR0FBRyxDQUMxQixHQUFZLEVBQzBDLEVBQUU7SUFDeEQsTUFBTSxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFDN0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ3JDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENhY2hlSGFuZGxlcixcbiAgSW52YWxpZGF0ZUNvbmZpZyxcbiAgSVNSSGFuZGxlckNvbmZpZyxcbiAgUmVuZGVyQ29uZmlnLFxuICBTZXJ2ZUZyb21DYWNoZUNvbmZpZyxcbn0gZnJvbSAnLi9tb2RlbHMnO1xuaW1wb3J0IHsgSW5NZW1vcnlDYWNoZUhhbmRsZXIgfSBmcm9tICcuL2NhY2hlLWhhbmRsZXJzJztcbmltcG9ydCB7IHJlbmRlclVybCwgUmVuZGVyVXJsQ29uZmlnIH0gZnJvbSAnLi91dGlscy9yZW5kZXItdXJsJztcbmltcG9ydCB7IGdldElTUk9wdGlvbnMgfSBmcm9tICcuL3V0aWxzL2dldC1pc3Itb3B0aW9ucyc7XG5pbXBvcnQgeyBDYWNoZVJlZ2VuZXJhdGlvbiB9IGZyb20gJy4vY2FjaGUtcmVnZW5lcmF0aW9uJztcbmltcG9ydCB7IE5leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IElTUkxvZ2dlciB9IGZyb20gJy4vaXNyLWxvZ2dlcic7XG5cbmV4cG9ydCBjbGFzcyBJU1JIYW5kbGVyIHtcbiAgcHJvdGVjdGVkIGNhY2hlITogQ2FjaGVIYW5kbGVyO1xuICBwcm90ZWN0ZWQgY2FjaGVSZWdlbmVyYXRpb24hOiBDYWNoZVJlZ2VuZXJhdGlvbjtcblxuICBwcm90ZWN0ZWQgaXNyQ29uZmlnOiBJU1JIYW5kbGVyQ29uZmlnO1xuXG4gIHByb3RlY3RlZCByZWFkb25seSBsb2dnZXI6IElTUkxvZ2dlcjtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc/OiBJU1JIYW5kbGVyQ29uZmlnKSB7XG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUHJvdmlkZSBJU1JIYW5kbGVyQ29uZmlnIScpO1xuICAgIH1cblxuICAgIHRoaXMuaXNyQ29uZmlnID0gY29uZmlnO1xuXG4gICAgdGhpcy5sb2dnZXIgPSBuZXcgSVNSTG9nZ2VyKGNvbmZpZz8uZW5hYmxlTG9nZ2luZyA/PyBmYWxzZSk7XG5cbiAgICAvLyBpZiBza2lwQ2FjaGluZ09uSHR0cEVycm9yIGlzIG5vdCBwcm92aWRlZCBpdCB3aWxsIGRlZmF1bHQgdG8gdHJ1ZVxuICAgIHRoaXMuaXNyQ29uZmlnLnNraXBDYWNoaW5nT25IdHRwRXJyb3IgPVxuICAgICAgY29uZmlnPy5za2lwQ2FjaGluZ09uSHR0cEVycm9yICE9PSBmYWxzZTtcblxuICAgIGlmIChjb25maWcuY2FjaGUgJiYgY29uZmlnLmNhY2hlIGluc3RhbmNlb2YgQ2FjaGVIYW5kbGVyKSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coJ1VzaW5nIGN1c3RvbSBjYWNoZSBoYW5kbGVyIScpO1xuICAgICAgdGhpcy5jYWNoZSA9IGNvbmZpZy5jYWNoZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKCdVc2luZyBpbiBtZW1vcnkgY2FjaGUgaGFuZGxlciEnKTtcbiAgICAgIHRoaXMuY2FjaGUgPSBuZXcgSW5NZW1vcnlDYWNoZUhhbmRsZXIoKTtcbiAgICB9XG5cbiAgICB0aGlzLmNhY2hlUmVnZW5lcmF0aW9uID0gbmV3IENhY2hlUmVnZW5lcmF0aW9uKFxuICAgICAgdGhpcy5jYWNoZSxcbiAgICAgIGNvbmZpZy5pbmRleEh0bWxcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgaW52YWxpZGF0ZShcbiAgICByZXE6IFJlcXVlc3QsXG4gICAgcmVzOiBSZXNwb25zZSxcbiAgICBjb25maWc/OiBJbnZhbGlkYXRlQ29uZmlnXG4gICk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgeyB0b2tlbiwgdXJsc1RvSW52YWxpZGF0ZSB9ID0gZXh0cmFjdERhdGFGcm9tQm9keShyZXEpO1xuICAgIGNvbnN0IHsgaW5kZXhIdG1sIH0gPSB0aGlzLmlzckNvbmZpZztcblxuICAgIGlmICh0b2tlbiAhPT0gdGhpcy5pc3JDb25maWcuaW52YWxpZGF0ZVNlY3JldFRva2VuKSB7XG4gICAgICByZXR1cm4gcmVzLmpzb24oeyBzdGF0dXM6ICdlcnJvcicsIG1lc3NhZ2U6ICdZb3VyIHNlY3JldCB0b2tlbiBpcyB3cm9uZyEhIScgfSk7XG4gICAgfVxuXG4gICAgaWYgKCF1cmxzVG9JbnZhbGlkYXRlIHx8ICF1cmxzVG9JbnZhbGlkYXRlLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHJlcy5qc29uKHsgc3RhdHVzOiAnZXJyb3InLCBtZXNzYWdlOiAnUGxlYXNlIGFkZCBgdXJsc1RvSW52YWxpZGF0ZWAgaW4gdGhlIHBheWxvYWQhJyB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBub3RJbkNhY2hlOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IHVybFdpdGhFcnJvcnM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuICAgIGZvciAoY29uc3QgdXJsIG9mIHVybHNUb0ludmFsaWRhdGUpIHtcbiAgICAgIGNvbnN0IHVybEV4aXN0cyA9IGF3YWl0IHRoaXMuY2FjaGUuaGFzKHVybCk7XG5cbiAgICAgIGlmICghdXJsRXhpc3RzKSB7XG4gICAgICAgIG5vdEluQ2FjaGUucHVzaCh1cmwpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gcmUtcmVuZGVyIHRoZSBwYWdlIGFnYWluXG4gICAgICAgIGNvbnN0IGh0bWwgPSBhd2FpdCByZW5kZXJVcmwoeyByZXEsIHJlcywgdXJsLCBpbmRleEh0bWwsIHByb3ZpZGVyczogY29uZmlnPy5wcm92aWRlcnMgfSk7XG5cbiAgICAgICAgLy8gZ2V0IHJldmFsaWRhdGUgZGF0YSBpbiBvcmRlciB0byBzZXQgaXQgdG8gY2FjaGUgZGF0YVxuICAgICAgICBjb25zdCB7IHJldmFsaWRhdGUsIGVycm9ycyB9ID0gZ2V0SVNST3B0aW9ucyhodG1sKTtcblxuICAgICAgICAvLyBpZiB0aGVyZSBhcmUgZXJyb3JzIHdoZW4gcmVuZGVyaW5nIHRoZSBzaXRlIHdlIHRocm93IGFuIGVycm9yXG4gICAgICAgIGlmIChlcnJvcnM/Lmxlbmd0aCAmJiB0aGlzLmlzckNvbmZpZy5za2lwQ2FjaGluZ09uSHR0cEVycm9yKSB7XG4gICAgICAgICAgdXJsV2l0aEVycm9yc1t1cmxdID0gZXJyb3JzO1xuICAgICAgICB9XG4gICAgICAgIC8vIGFkZCB0aGUgcmVnZW5lcmF0ZWQgcGFnZSB0byBjYWNoZVxuICAgICAgICBhd2FpdCB0aGlzLmNhY2hlLmFkZChyZXEudXJsLCBodG1sLCB7IHJldmFsaWRhdGUgfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdXJsV2l0aEVycm9yc1t1cmxdID0gZXJyO1xuICAgICAgfVxuXG4gICAgfVxuXG4gICAgY29uc3QgaW52YWxpZGF0ZWRVcmxzID0gdXJsc1RvSW52YWxpZGF0ZS5maWx0ZXIodXJsID0+ICFub3RJbkNhY2hlLmluY2x1ZGVzKHVybCkgJiYgIXVybFdpdGhFcnJvcnNbdXJsXSk7XG5cbiAgICBpZiAobm90SW5DYWNoZS5sZW5ndGgpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgVXJsczogJHsgbm90SW5DYWNoZS5qb2luKCcsICcpIH0gZG9lcyBub3QgZXhpc3QgaW4gY2FjaGUuYCk7XG4gICAgfVxuXG4gICAgaWYgKE9iamVjdC5rZXlzKHVybFdpdGhFcnJvcnMpLmxlbmd0aCkge1xuICAgICAgdGhpcy5sb2dnZXIubG9nKGBVcmxzOiAke09iamVjdC5rZXlzKHVybFdpdGhFcnJvcnMpLmpvaW4oJywgJyl9IGhhZCBlcnJvcnMgd2hpbGUgcmVnZW5lcmF0aW5nIWApO1xuICAgIH1cblxuICAgIGlmIChpbnZhbGlkYXRlZFVybHMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFVybHM6ICR7IGludmFsaWRhdGVkVXJscy5qb2luKCcsICcpIH0gd2VyZSByZWdlbmVyYXRlZCFgKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXNwb25zZSA9IHsgc3RhdHVzOiAnc3VjY2VzcycsIG5vdEluQ2FjaGUsIHVybFdpdGhFcnJvcnMsIGludmFsaWRhdGVkVXJscyB9O1xuICAgIHJldHVybiByZXMuanNvbihyZXNwb25zZSk7XG4gIH1cblxuICBhc3luYyBzZXJ2ZUZyb21DYWNoZShcbiAgICByZXE6IFJlcXVlc3QsXG4gICAgcmVzOiBSZXNwb25zZSxcbiAgICBuZXh0OiBOZXh0RnVuY3Rpb24sXG4gICAgY29uZmlnPzogU2VydmVGcm9tQ2FjaGVDb25maWdcbiAgKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY2FjaGVEYXRhID0gYXdhaXQgdGhpcy5jYWNoZS5nZXQocmVxLnVybCk7XG4gICAgICBjb25zdCB7IGh0bWwsIG9wdGlvbnMsIGNyZWF0ZWRBdCB9ID0gY2FjaGVEYXRhO1xuXG4gICAgICAvLyBpZiB0aGUgY2FjaGUgaXMgZXhwaXJlZCwgd2Ugd2lsbCByZWdlbmVyYXRlIGl0XG4gICAgICBpZiAob3B0aW9ucy5yZXZhbGlkYXRlICYmIG9wdGlvbnMucmV2YWxpZGF0ZSA+IDApIHtcbiAgICAgICAgY29uc3QgbGFzdENhY2hlRGF0ZURpZmYgPSAoRGF0ZS5ub3coKSAtIGNyZWF0ZWRBdCkgLyAxMDAwOyAvLyBpbiBzZWNvbmRzXG5cbiAgICAgICAgaWYgKGxhc3RDYWNoZURhdGVEaWZmID4gb3B0aW9ucy5yZXZhbGlkYXRlKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5jYWNoZVJlZ2VuZXJhdGlvbi5yZWdlbmVyYXRlKFxuICAgICAgICAgICAgcmVxLFxuICAgICAgICAgICAgcmVzLFxuICAgICAgICAgICAgY2FjaGVEYXRhLFxuICAgICAgICAgICAgdGhpcy5sb2dnZXIsXG4gICAgICAgICAgICBjb25maWc/LnByb3ZpZGVyc1xuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQXBwbHkgdGhlIGNhbGxiYWNrIGlmIGdpdmVuXG4gICAgICBsZXQgZmluYWxIdG1sID0gaHRtbDtcbiAgICAgIGlmKGNvbmZpZz8ubW9kaWZ5Q2FjaGVkSHRtbCkge1xuICAgICAgICBjb25zdCB0aW1lU3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICAgICAgZmluYWxIdG1sID0gY29uZmlnLm1vZGlmeUNhY2hlZEh0bWwocmVxLCBodG1sKTtcbiAgICAgICAgY29uc3QgdG90YWxUaW1lID0gcGVyZm9ybWFuY2Uubm93KCkgLSB0aW1lU3RhcnQ7XG4gICAgICAgIGZpbmFsSHRtbCArPSBgPCEtLVxcbuKEue+4jyBOZ3hJU1I6IFRoaXMgY2FjaGVkSHRtbCBoYXMgYmVlbiBtb2RpZmllZCB3aXRoIG1vZGlmeUNhY2hlZEh0bWwoKVxcbuKdl++4jyBUaGlzIHJlc3VsdGVkIGludG8gbW9yZSAke3RvdGFsVGltZS50b0ZpeGVkKDIpfW1zIG9mIHByb2Nlc3NpbmcgdGltZS5cXG4tLT5gO1xuICAgICAgfVxuXG4gICAgICAvLyBDYWNoZSBleGlzdHMuIFNlbmQgaXQuXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFBhZ2Ugd2FzIHJldHJpZXZlZCBmcm9tIGNhY2hlOiBgLCByZXEudXJsKTtcbiAgICAgIHJldHVybiByZXMuc2VuZChmaW5hbEh0bWwpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBDYWNoZSBkb2VzIG5vdCBleGlzdC4gU2VydmUgdXNlciB1c2luZyBTU1JcbiAgICAgIG5leHQoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyByZW5kZXIoXG4gICAgcmVxOiBSZXF1ZXN0LFxuICAgIHJlczogUmVzcG9uc2UsXG4gICAgbmV4dDogTmV4dEZ1bmN0aW9uLFxuICAgIGNvbmZpZz86IFJlbmRlckNvbmZpZ1xuICApOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHJlbmRlclVybENvbmZpZzogUmVuZGVyVXJsQ29uZmlnID0ge1xuICAgICAgcmVxLFxuICAgICAgcmVzLFxuICAgICAgdXJsOiByZXEudXJsLFxuICAgICAgaW5kZXhIdG1sOiB0aGlzLmlzckNvbmZpZy5pbmRleEh0bWwsXG4gICAgICBwcm92aWRlcnM6IGNvbmZpZz8ucHJvdmlkZXJzLFxuICAgIH07XG5cbiAgICByZW5kZXJVcmwocmVuZGVyVXJsQ29uZmlnKS50aGVuKGFzeW5jIChodG1sKSA9PiB7XG4gICAgICBjb25zdCB7IHJldmFsaWRhdGUsIGVycm9ycyB9ID0gZ2V0SVNST3B0aW9ucyhodG1sKTtcblxuICAgICAgLy8gQXBwbHkgdGhlIGNhbGxiYWNrIGlmIGdpdmVuXG4gICAgICBjb25zdCBmaW5hbEh0bWwgPSBjb25maWc/Lm1vZGlmeUdlbmVyYXRlZEh0bWwgPyBjb25maWcubW9kaWZ5R2VuZXJhdGVkSHRtbChyZXEsIGh0bWwpIDogaHRtbDtcblxuICAgICAgLy8gaWYgd2UgaGF2ZSBhbnkgaHR0cCBlcnJvcnMgd2hlbiByZW5kZXJpbmcgdGhlIHNpdGUsIGFuZCB3ZSBoYXZlIHNraXBDYWNoaW5nT25IdHRwRXJyb3IgZW5hYmxlZFxuICAgICAgLy8gd2UgZG9uJ3Qgd2FudCB0byBjYWNoZSBpdCwgYW5kLCB3ZSB3aWxsIGZhbGwgYmFjayB0byBjbGllbnQgc2lkZSByZW5kZXJpbmdcbiAgICAgIGlmIChlcnJvcnM/Lmxlbmd0aCAmJiB0aGlzLmlzckNvbmZpZy5za2lwQ2FjaGluZ09uSHR0cEVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmxvZygnSHR0cCBlcnJvcnM6IFxcbicsIGVycm9ycyk7XG4gICAgICAgIHJldHVybiByZXMuc2VuZChmaW5hbEh0bWwpO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiByZXZhbGlkYXRlIGlzIG51bGwgd2Ugd29uJ3QgY2FjaGUgaXRcbiAgICAgIC8vIGlmIHJldmFsaWRhdGUgaXMgMCwgd2Ugd2lsbCBuZXZlciBjbGVhciB0aGUgY2FjaGUgYXV0b21hdGljYWxseVxuICAgICAgLy8gaWYgcmV2YWxpZGF0ZSBpcyB4LCB3ZSB3aWxsIGNsZWFyIGNhY2hlIGV2ZXJ5IHggc2Vjb25kcyAoYWZ0ZXIgdGhlIGxhc3QgcmVxdWVzdCkgZm9yIHRoYXQgdXJsXG5cbiAgICAgIGlmIChyZXZhbGlkYXRlID09PSBudWxsIHx8IHJldmFsaWRhdGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAvLyBkb24ndCBkbyAhcmV2YWxpZGF0ZSBiZWNhdXNlIGl0IHdpbGwgYWxzbyBjYXRjaCBcIjBcIlxuICAgICAgICByZXR1cm4gcmVzLnNlbmQoZmluYWxIdG1sKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2FjaGUgdGhlIHJlbmRlcmVkIGBodG1sYCBmb3IgdGhpcyByZXF1ZXN0IHVybCB0byB1c2UgZm9yIHN1YnNlcXVlbnQgcmVxdWVzdHNcbiAgICAgIGF3YWl0IHRoaXMuY2FjaGUuYWRkKHJlcS51cmwsIGZpbmFsSHRtbCwgeyByZXZhbGlkYXRlIH0pO1xuICAgICAgcmV0dXJuIHJlcy5zZW5kKGZpbmFsSHRtbCk7XG4gICAgfSk7XG4gIH1cbn1cblxuY29uc3QgZXh0cmFjdERhdGFGcm9tQm9keSA9IChcbiAgcmVxOiBSZXF1ZXN0XG4pOiB7IHRva2VuOiBzdHJpbmcgfCBudWxsOyB1cmxzVG9JbnZhbGlkYXRlOiBzdHJpbmdbXSB9ID0+IHtcbiAgY29uc3QgeyB1cmxzVG9JbnZhbGlkYXRlLCB0b2tlbiB9ID0gcmVxLmJvZHk7XG4gIHJldHVybiB7IHVybHNUb0ludmFsaWRhdGUsIHRva2VuIH07XG59O1xuIl19