import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { DOCUMENT, isPlatformServer } from '@angular/common';
import { ChildActivationEnd } from '@angular/router';
import { filter, map, take } from 'rxjs/operators';
import { BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
const initialState = {
    revalidate: null,
    errors: [],
    extra: {}
};
export class NgxIsrService {
    constructor(platformId, doc, router) {
        this.platformId = platformId;
        this.doc = doc;
        this.router = router;
        this.state = new BehaviorSubject(initialState);
        this.setRevalidate = (revalidate) => {
            this.state.next({ ...this.getState(), revalidate });
        };
        if (isPlatformServer(this.platformId)) {
            this.activate();
        }
    }
    getState() {
        return this.state.getValue();
    }
    getExtra() {
        return this.state.getValue().extra;
    }
    activate() {
        this.router.events
            .pipe(filter((e) => e instanceof ChildActivationEnd), map((event) => {
            let snapshot = event.snapshot;
            while (snapshot.firstChild !== null) {
                snapshot = snapshot.firstChild;
            }
            return snapshot.data;
        }), take(1))
            .subscribe((data) => {
            if (data?.['revalidate'] !== undefined) {
                this.setRevalidate(data['revalidate']);
            }
        });
    }
    addError(err) {
        const currentErrors = this.getState().errors;
        this.state.next({ ...this.getState(), errors: [...currentErrors, err] });
    }
    addExtra(extra = {}) {
        this.state.next({ ...this.getState(), extra: { ...this.getExtra(), ...extra } });
    }
}
NgxIsrService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: NgxIsrService, deps: [{ token: PLATFORM_ID }, { token: DOCUMENT }, { token: i1.Router }], target: i0.ɵɵFactoryTarget.Injectable });
NgxIsrService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: NgxIsrService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: NgxIsrService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: Object, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }, { type: i1.Router }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWlzci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWlzci9zcmMvbGliL25neC1pc3Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxFQUFFLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdELE9BQU8sRUFBRSxrQkFBa0IsRUFBVSxNQUFNLGlCQUFpQixDQUFDO0FBQzdELE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7OztBQVN2QyxNQUFNLFlBQVksR0FBZ0I7SUFDaEMsVUFBVSxFQUFFLElBQUk7SUFDaEIsTUFBTSxFQUFFLEVBQUU7SUFDVixLQUFLLEVBQUUsRUFBRTtDQUNWLENBQUE7QUFHRCxNQUFNLE9BQU8sYUFBYTtJQVd4QixZQUMrQixVQUFrQixFQUNyQixHQUFhLEVBQy9CLE1BQWM7UUFGTyxlQUFVLEdBQVYsVUFBVSxDQUFRO1FBQ3JCLFFBQUcsR0FBSCxHQUFHLENBQVU7UUFDL0IsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQWJkLFVBQUssR0FBRyxJQUFJLGVBQWUsQ0FBYyxZQUFZLENBQUMsQ0FBQztRQWlEakUsa0JBQWEsR0FBRyxDQUFDLFVBQXlCLEVBQVEsRUFBRTtZQUNsRCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDdEQsQ0FBQyxDQUFBO1FBcENDLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUNqQjtJQUNILENBQUM7SUFoQkQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxLQUFLLENBQUM7SUFDckMsQ0FBQztJQVlELFFBQVE7UUFDTixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU07YUFDZixJQUFJLENBQ0gsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLFlBQVksa0JBQWtCLENBQUMsRUFDOUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDWixJQUFJLFFBQVEsR0FBSSxLQUE0QixDQUFDLFFBQVEsQ0FBQztZQUN0RCxPQUFPLFFBQVEsQ0FBQyxVQUFVLEtBQUssSUFBSSxFQUFFO2dCQUNuQyxRQUFRLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBQzthQUNoQztZQUNELE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQztRQUN2QixDQUFDLENBQUMsRUFDRixJQUFJLENBQUMsQ0FBQyxDQUFDLENBQ1I7YUFDQSxTQUFTLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRTtZQUN2QixJQUFJLElBQUksRUFBRSxDQUFDLFlBQVksQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDdEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQzthQUN4QztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFFBQVEsQ0FBQyxHQUFzQjtRQUM3QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsTUFBTSxDQUFDO1FBQzdDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUUsR0FBRyxhQUFhLEVBQUUsR0FBRyxDQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFRCxRQUFRLENBQUMsUUFBNkIsRUFBRTtRQUN0QyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ25GLENBQUM7OzBHQWhEVSxhQUFhLGtCQVlkLFdBQVcsYUFDWCxRQUFROzhHQWJQLGFBQWEsY0FEQSxNQUFNOzJGQUNuQixhQUFhO2tCQUR6QixVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7MEJBYTdCLE1BQU07MkJBQUMsV0FBVzs7MEJBQ2xCLE1BQU07MkJBQUMsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERPQ1VNRU5ULCBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IENoaWxkQWN0aXZhdGlvbkVuZCwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuZXhwb3J0IGludGVyZmFjZSBOZ3hJc3JTdGF0ZSB7XG4gIHJldmFsaWRhdGU6IG51bWJlciB8IG51bGw7XG4gIGVycm9yczogRXJyb3JbXTtcbiAgZXh0cmE6IFJlY29yZDxzdHJpbmcsIGFueT47XG59XG5cbmNvbnN0IGluaXRpYWxTdGF0ZTogTmd4SXNyU3RhdGUgPSB7XG4gIHJldmFsaWRhdGU6IG51bGwsXG4gIGVycm9yczogW10sXG4gIGV4dHJhOiB7fVxufVxuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIE5neElzclNlcnZpY2Uge1xuICBwcm90ZWN0ZWQgc3RhdGUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE5neElzclN0YXRlPihpbml0aWFsU3RhdGUpO1xuXG4gIGdldFN0YXRlKCk6IE5neElzclN0YXRlIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5nZXRWYWx1ZSgpO1xuICB9XG5cbiAgZ2V0RXh0cmEoKTogUmVjb3JkPHN0cmluZywgYW55PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0VmFsdWUoKS5leHRyYTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogT2JqZWN0LFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jOiBEb2N1bWVudCxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyXG4gICkge1xuICAgIGlmIChpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIHRoaXMuYWN0aXZhdGUoKTtcbiAgICB9XG4gIH1cblxuICBhY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnJvdXRlci5ldmVudHNcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoKGUpID0+IGUgaW5zdGFuY2VvZiBDaGlsZEFjdGl2YXRpb25FbmQpLFxuICAgICAgICBtYXAoKGV2ZW50KSA9PiB7XG4gICAgICAgICAgbGV0IHNuYXBzaG90ID0gKGV2ZW50IGFzIENoaWxkQWN0aXZhdGlvbkVuZCkuc25hcHNob3Q7XG4gICAgICAgICAgd2hpbGUgKHNuYXBzaG90LmZpcnN0Q2hpbGQgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHNuYXBzaG90ID0gc25hcHNob3QuZmlyc3RDaGlsZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHNuYXBzaG90LmRhdGE7XG4gICAgICAgIH0pLFxuICAgICAgICB0YWtlKDEpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGRhdGE/LlsncmV2YWxpZGF0ZSddICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0aGlzLnNldFJldmFsaWRhdGUoZGF0YVsncmV2YWxpZGF0ZSddKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBhZGRFcnJvcihlcnI6IEh0dHBFcnJvclJlc3BvbnNlKTogdm9pZCB7XG4gICAgY29uc3QgY3VycmVudEVycm9ycyA9IHRoaXMuZ2V0U3RhdGUoKS5lcnJvcnM7XG4gICAgdGhpcy5zdGF0ZS5uZXh0KHsgLi4udGhpcy5nZXRTdGF0ZSgpLCBlcnJvcnM6IFsgLi4uY3VycmVudEVycm9ycywgZXJyIF0gfSk7XG4gIH1cblxuICBhZGRFeHRyYShleHRyYTogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9KTogdm9pZCB7XG4gICAgdGhpcy5zdGF0ZS5uZXh0KHsgLi4udGhpcy5nZXRTdGF0ZSgpLCBleHRyYTogeyAuLi50aGlzLmdldEV4dHJhKCksIC4uLmV4dHJhIH0gfSk7XG4gIH1cbiAgXG4gIHNldFJldmFsaWRhdGUgPSAocmV2YWxpZGF0ZTogbnVtYmVyIHwgbnVsbCk6IHZvaWQgPT4ge1xuICAgIHRoaXMuc3RhdGUubmV4dCh7IC4uLnRoaXMuZ2V0U3RhdGUoKSwgcmV2YWxpZGF0ZSB9KTtcbiAgfVxuXG59XG4iXX0=